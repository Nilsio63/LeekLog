@page "/register"
@using LeekLog.Abstractions.Entites;
@using LeekLog.Abstractions.Models;
@using LeekLog.Authentication;
@using LeekLog.Data.Abstractions.Stores;
@using LeekLog.Services.Abstractions;
@inject NavigationManager _navManager
@inject IUserAuthService _userAuthService
@inject IUserStore _userStore
@inject IUserService _userService

<PageTitle>Register</PageTitle>

<MudText Typo="Typo.h3">Sign up</MudText>

<MudGrid>
    <AuthorizeView>
        <Authorized>
            <MudItem>
                <MudAlert Severity="Severity.Warning">
                    Come on, man ... you are logged in, why do you want to sign up a new account?<br />
                    How did you even get here?
                </MudAlert>
            </MudItem>
        </Authorized>
        <NotAuthorized>
            <MudItem xs="12">
                <MudText Typo="Typo.subtitle1">
                    Enter a unique <i>(and cool)</i> user name and password to sign up to Leek Log!
                </MudText>
            </MudItem>

            <MudItem xs="12">
                <MudForm Model="this">
                    <MudTextField Label="User name" @bind-Value="UserName" />
                    <MudTextField Label="Password" @bind-Value="Password" />
                    <MudTextField Label="Repeat password" @bind-Value="PasswordRepeat" />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RegisterAsync">Register</MudButton>
                </MudForm>
            </MudItem>

            @if (!string.IsNullOrWhiteSpace(ErrorMessage))
            {
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Error">@ErrorMessage</MudAlert>
                </MudItem>
            }
        </NotAuthorized>
    </AuthorizeView>
</MudGrid>

@code {
    public string UserName { get; set; } = string.Empty;
    public string Password { get; set; } = string.Empty;
    public string PasswordRepeat { get; set; } = string.Empty;
    public string? ErrorMessage { get; set; }

    public async Task RegisterAsync()
    {
        if (!string.Equals(Password, PasswordRepeat, StringComparison.Ordinal))
        {
            ErrorMessage = "Password didn't match password repetition";

            return;
        }

        UserCreationResult result = await _userService.TrySaveUserAsync(UserName, Password);

        if (result.Success == false)
        {
            ErrorMessage = result.ErrorMessage;

            return;
        }

        await _userAuthService.LoginAsync(result.CreatedUser);

        _navManager.NavigateTo("/");
    }
}
